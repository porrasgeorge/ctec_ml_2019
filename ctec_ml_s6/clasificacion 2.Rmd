---
title: "Clase 6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Tarea 6.
# Metodos supervisados 2

Librerias
```{r}
library(caTools)
library(rpart)
library(tidyverse)
library(GGally)
library(visdat)
library(rpart.plot)
library(pROC)

#..........Librerias de los modelos
```

1. Desarolle el An?lisis del Problema
```{r}
# Construya el análisis del problema


# Los datos se obtienen mediante el  parte oficial de tr?nsito que realiza la Direcci?n General de Polic?a de Tr?nsito al presentarse un accidente, los cuales ingresan a la base de datos de dos formas (hand held y papel). Debido a que parte de la labor principal de la Instituci?n es salvar vidas, y por los recursos limitados que existen, se trabaja solo con accidentes con heridos y/o fallecidos; y no se trabaja con accidentes que presentan solo da?os materiales. Adem?s, posteriormente inicia el proceso de limpieza, correcci?n de inconsistencias, validaci?n de algunas variables,  georeferenciaci?n de los accidentes, entre otros.


#Accidente con v?ctima se refiere cuando en el accidente de tr?nsito al menos uno de los participantes resulto: herido leve, grave o fallecido.

#Para m?s informaci?n revisar la metodolog?a del documento Memoria estad?stica de accidentes de tr?nsito con v?ctimas.Periodo 2012-2014.

```
Fuente del dataset:
http://datosabiertos.csv.go.cr/dashboards/19683/accidentes/

1. Cargue el archivo nombre.csv en una variable

```{r}
datos <- read.csv("temp_5571830814335439232.csv", header = T, na.strings = c("Desconocido", "Desconocida"))


```

2. Desarolle el Entendimiento de los Datos

Todos los datos son factores a excepcion de A_Persona
```{r}
glimpse(datos)

```

se puede observar que los datos en la columna A_Persona es siempre 1, 
para todas las 158399 observaciones, por lo que se puede eliminar

```{r}
table(datos[1])
datos[1] <- NULL
```

Se modifican algunos nombres de columnas para eliminar tildes y otros

```{r}
names(datos)
names(datos)[2] <- "Tipo_Lesion"
names(datos)[4] <- "Edad_quinquenal"
names(datos)[6] <- "Anho"
names(datos)[8] <- "Dia"
names(datos)[10] <- "Canton"
names(datos)[12] <- "Dia_2"
names(datos)[13] <- "Mes_2"
names(datos)[14] <- "Edad_quinquenal_2"
datos$Edad <- as.integer(as.character(datos$Edad))

glimpse(datos)
class(datos$Edad)

```

comparando los datos de las 2 columnas de EdadQuinquenal, se puede observar que son identicas, lo unico que varia es el nombre de la etiqueta, por lo que se puede eliminar una de ellas.

Eso se puede deducir pues la comparacion de ellas forman una matriz diagonal (aunque en distorsionada debido al ordenamiento alfabetico de las etiquetas)

```{r}
table(datos$Edad_quinquenal, datos$Edad_quinquenal_2)

```

Lo mismo del punto anterior ocurre con la columna Dia.

```{r}
table(datos$Dia, datos$Dia_2)
```

Lo mismo del punto tras-anterior ocurre con la columna Mes.

```{r}
table(datos$Mes, datos$Mes_2)

```

```{r}
datos$Edad_quinquenal_2 <- NULL
datos$Dia_2 <- NULL
datos$Mes_2 <- NULL

glimpse(datos)

```



Edad_quinquenal es una clasificacion de edad, donde se agrupa de 5 en 5 años. se puede dejar pues quiza algun metodo funcione mejor con ella, sin embargo considero que se deberia usar o una o la otra



3. Utilizando barplot cree un gr?fico de los atributos del dataset, observe las correlaciones entre atributos

```{r}
Rol_Lesion <- table(datos$Rol, datos$Tipo_Lesion)

gg_formato <- geom_bar(stat = "count",
                       width = 0.7,
                       fill = "steelblue")
gg_tipo <- theme(
  axis.text.x = element_text(
    face = "bold",
    color = "#993333",
    size = 8,
    angle = 90
  ),
  axis.text.y = element_text(face = "bold",
                             color = "blue",
                             size = 10)
)

ggplot(datos, aes(x = Rol)) + gg_formato + gg_tipo
ggplot(datos, aes(x = Tipo_Lesion)) + gg_formato + gg_tipo
hist(datos$Edad, col = "steelblue")
ggplot(datos, aes(x = Edad_quinquenal)) + gg_formato + gg_tipo
ggplot(datos, aes(x = Sexo)) + gg_formato + gg_tipo
ggplot(datos, aes(x = Anho)) + gg_formato + gg_tipo
ggplot(datos, aes(x = Mes)) + gg_formato + gg_tipo
ggplot(datos, aes(x = Dia)) + gg_formato + gg_tipo
ggplot(datos, aes(x = Provincia)) + gg_formato + gg_tipo
```


# Se quiere determinar si dadas las caracteristicas de un accidente, se tienen muertos o heridos graves

```{r}

cosevi <- datos %>% 
  mutate(HayHerido = as.factor(ifelse(!Tipo_Lesion %in% c("Ileso"), "Si", "No"))) %>%
  select(HayHerido, Rol, Edad_quinquenal, Sexo, Dia) %>%
  filter(!is.na(Sexo), !is.na(Edad_quinquenal))

glimpse(cosevi)
sum(is.na(cosevi))

```

# Datos de entrenamiento y prueba

```{r}
set.seed(123456789)
split_var <- sample.split(cosevi$HayHerido, SplitRatio = 0.7)
cosevi_training <- cosevi[split_var,]
cosevi_test <- cosevi[!split_var,]
```

Revisando la distribucion de los datos

```{r}
100 * nrow(cosevi_training) / nrow(cosevi)
100 * nrow(cosevi_test) / nrow(cosevi)
```

Revisando la distribucion de los datos, como era de esperar, el 70% de los datos con la etiqueta Grave o muerto == si va para el training,
lo mismo pasa con los datos con la etiqueta == NO

o sea sample.split trata de dividir cada una de las etiquetas en 70% training y 30% test.

```{r}
100 * sum(cosevi_training$HayHerido == "Si") / sum(cosevi$HayHerido == "Si")
100 * sum(cosevi_test$HayHerido == "Si") / sum(cosevi$HayHerido == "Si")

100 * sum(cosevi_training$HayHerido == "No") / sum(cosevi$HayHerido == "No")
100 * sum(cosevi_test$HayHerido == "No") / sum(cosevi$HayHerido == "No")
```


4. Realice al menos 5 modelos de los observados en clase

Arbol de decision

```{r}
Arbol_modelo <- rpart(formula = HayHerido ~ ., 
                      data = cosevi_training, 
                      method = "class")

rpart.plot(Arbol_modelo)


```


```{r}

predicted_Arbol_modelo <- predict(Arbol_modelo, 
                                newdata = cosevi_test, 
                                type = "class",
                                )
tabla <- table(cosevi_test$HayHerido,
      predicted_Arbol_modelo)

tabla

```





5. Evaluaci?n de los modelos
```{r}
plot(predicted_Arbol_modelo, cosevi_test$HayHerido)

library(PRROC)

PRROC_obj <- roc.curve(scores.class0 = predicted_Arbol_modelo, weights.class0 = cosevi_test$HayHerido,
                       curve=TRUE)
plot(PRROC_obj)
```


6. Desarolle al menos 5 conclusiones sobre las clasificaciones de los modelos



